<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rangitoto Year 9 Review Hub</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%); min-height: 100vh; color: white; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .glass { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 30px; margin-bottom: 20px; }
        .btn { background: linear-gradient(135deg, #8b5cf6, #ec4899); border: none; color: white; padding: 15px 30px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; width: 100%; margin-bottom: 10px; }
        .btn:hover { transform: scale(1.02); box-shadow: 0 10px 30px rgba(139,92,246,0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: rgba(255,255,255,0.2); }
        .btn-small { padding: 10px 16px; font-size: 14px; width: auto; }
        .btn-green { background: linear-gradient(135deg, #22c55e, #14b8a6); }
        .btn-blue { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
        .btn-orange { background: linear-gradient(135deg, #f97316, #eab308); }
        .input { width: 100%; padding: 15px 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 16px; margin-bottom: 15px; }
        .input::placeholder { color: rgba(255,255,255,0.5); }
        .input:focus { outline: none; border-color: #8b5cf6; }
        textarea.input { min-height: 120px; resize: vertical; font-family: monospace; font-size: 12px; }
        .text-center { text-align: center; }
        .mb-4 { margin-bottom: 16px; }
        .mb-6 { margin-bottom: 24px; }
        .mt-4 { margin-top: 16px; }
        .text-6xl { font-size: 60px; }
        .text-5xl { font-size: 48px; }
        .text-4xl { font-size: 36px; }
        .text-3xl { font-size: 30px; }
        .text-2xl { font-size: 24px; }
        .text-xl { font-size: 20px; }
        .text-lg { font-size: 18px; }
        .text-sm { font-size: 14px; }
        .text-xs { font-size: 12px; }
        .text-gray { color: rgba(255,255,255,0.6); }
        .text-yellow { color: #fbbf24; }
        .text-green { color: #34d399; }
        .text-red { color: #f87171; }
        .text-purple { color: #c084fc; }
        .text-blue { color: #60a5fa; }
        .text-orange { color: #fb923c; }
        .font-bold { font-weight: bold; }
        .hidden { display: none; }
        .flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .gap-4 { gap: 16px; }
        .grid { display: grid; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .subject-card { background: linear-gradient(135deg, var(--from), var(--to)); padding: 20px; border-radius: 16px; cursor: pointer; transition: transform 0.2s; text-align: left; border: none; color: white; width: 100%; }
        .subject-card:hover { transform: translateY(-5px); }
        .subject-card .icon { font-size: 40px; margin-bottom: 10px; }
        .option-btn { background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: white; padding: 15px 20px; border-radius: 12px; cursor: pointer; text-align: left; transition: all 0.2s; margin-bottom: 10px; display: block; width: 100%; font-size: 16px; }
        .option-btn:hover { background: rgba(139,92,246,0.3); transform: translateX(5px); }
        .option-btn.correct { background: rgba(34,197,94,0.3); border-color: #22c55e; }
        .option-btn.wrong { background: rgba(239,68,68,0.3); border-color: #ef4444; }
        .progress-bar { height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #8b5cf6, #ec4899); border-radius: 4px; transition: width 0.3s; }
        .stats-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .badge-tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .badge-green { background: #22c55e; }
        .badge-yellow { background: #eab308; }
        .badge-purple { background: #8b5cf6; }
        .badge-blue { background: #3b82f6; }
        .nav { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 14px; }
        .nav-btn.active { background: linear-gradient(135deg, #8b5cf6, #ec4899); }
        .header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .health-bar { padding: 8px 16px; border-radius: 10px; font-weight: bold; }
        .health-good { background: linear-gradient(135deg, #22c55e, #34d399); }
        .health-warning { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
        .health-danger { background: linear-gradient(135deg, #ef4444, #f87171); }
        .alert { padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .alert-info { background: rgba(59,130,246,0.2); border: 1px solid rgba(59,130,246,0.5); }
        .alert-success { background: rgba(34,197,94,0.2); border: 1px solid rgba(34,197,94,0.5); }
        .alert-warning { background: rgba(245,158,11,0.2); border: 1px solid rgba(245,158,11,0.5); }
        .alert-error { background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.5); }
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 10px 10px 0 0; cursor: pointer; }
        .tab.active { background: rgba(255,255,255,0.2); }
        
        /* Badge Card Styles */
        .badge-card { background: rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; text-align: center; transition: all 0.3s; position: relative; overflow: hidden; }
        .badge-card.earned { background: linear-gradient(135deg, rgba(139,92,246,0.3), rgba(236,72,153,0.3)); border: 2px solid rgba(139,92,246,0.5); }
        .badge-card.locked { opacity: 0.5; filter: grayscale(0.8); }
        .badge-card .badge-icon { font-size: 48px; margin-bottom: 10px; display: block; }
        .badge-card.locked .badge-icon { filter: grayscale(1); }
        .badge-card .badge-name { font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .badge-card .badge-desc { font-size: 12px; color: rgba(255,255,255,0.6); }
        .badge-card .badge-progress { margin-top: 10px; }
        .badge-card.earned::after { content: '‚úì'; position: absolute; top: 10px; right: 10px; background: #22c55e; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }
        .new-badge { animation: pulse 0.5s ease-in-out 3; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .floating { animation: float 3s ease-in-out infinite; }
        @keyframes bounce { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        .bounce-in { animation: bounce 0.5s cubic-bezier(0.68,-0.55,0.265,1.55); }
        @keyframes celebrate { 0% { transform: scale(1) rotate(0deg); } 25% { transform: scale(1.2) rotate(-5deg); } 50% { transform: scale(1.2) rotate(5deg); } 75% { transform: scale(1.1) rotate(-3deg); } 100% { transform: scale(1) rotate(0deg); } }
        .celebrate { animation: celebrate 0.6s ease-in-out; }
        .topic-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 12px 16px; border-radius: 10px; cursor: pointer; width: 100%; text-align: left; margin-top: 8px; display: flex; justify-content: space-between; }
        .topic-btn:hover { background: rgba(255,255,255,0.2); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal { background: linear-gradient(135deg, #1e1b4b, #312e81); border-radius: 20px; padding: 30px; max-width: 550px; width: 100%; max-height: 90vh; overflow-y: auto; }
        @media (max-width: 600px) { .grid-2 { grid-template-columns: 1fr; } .grid-3 { grid-template-columns: repeat(2, 1fr); } .header { flex-direction: column; align-items: flex-start; } }
    </style>
</head>
<body>
    <div class="container" id="app"></div>

    <script>
        // ============ BADGES DEFINITION ============
        const badgesDef = {
            first_steps: { id: 'first_steps', icon: 'üéØ', name: 'First Steps', desc: 'Complete your first exam', check: s => s.exams >= 1 },
            on_fire: { id: 'on_fire', icon: 'üî•', name: 'On Fire', desc: '3-day study streak', check: s => s.streak >= 3 },
            week_warrior: { id: 'week_warrior', icon: '‚öîÔ∏è', name: 'Week Warrior', desc: '7-day study streak', check: s => s.streak >= 7 },
            perfectionist: { id: 'perfectionist', icon: 'üíØ', name: 'Perfectionist', desc: 'Get 100% on any exam', check: s => s.perfect >= 1 },
            math_wizard: { id: 'math_wizard', icon: 'üßô', name: 'Math Wizard', desc: 'Complete 5 Math exams', check: s => s.subjects.math >= 5 },
            wordsmith: { id: 'wordsmith', icon: 'üìñ', name: 'Wordsmith', desc: 'Complete 5 English exams', check: s => s.subjects.english >= 5 },
            scientist: { id: 'scientist', icon: 'üî≠', name: 'Scientist', desc: 'Complete 5 Science exams', check: s => s.subjects.science >= 5 },
            historian: { id: 'historian', icon: 'üåè', name: 'Historian', desc: 'Complete 5 Social Science exams', check: s => s.subjects.social >= 5 },
            excellence: { id: 'excellence', icon: 'üèÜ', name: 'Excellence Achiever', desc: 'Get E7 or E8 grade', check: s => s.excellence >= 1 },
            dedicated: { id: 'dedicated', icon: 'üìö', name: 'Dedicated Learner', desc: 'Complete 10 exams total', check: s => s.exams >= 10 },
            speed_demon: { id: 'speed_demon', icon: '‚ö°', name: 'Speed Demon', desc: 'Finish exam under 2 minutes', check: s => s.fastExams >= 1 },
            unstoppable: { id: 'unstoppable', icon: 'üöÄ', name: 'Unstoppable', desc: 'Complete 25 exams total', check: s => s.exams >= 25 },
            master: { id: 'master', icon: 'üëë', name: 'Master Student', desc: 'Earn 5000+ XP', check: s => s.xp >= 5000 },
            streak_king: { id: 'streak_king', icon: 'üëë', name: 'Streak King', desc: '14-day study streak', check: s => s.streak >= 14 },
            all_rounder: { id: 'all_rounder', icon: 'üåü', name: 'All Rounder', desc: 'Complete 3+ exams in each subject', check: s => s.subjects.math >= 3 && s.subjects.english >= 3 && s.subjects.science >= 3 && s.subjects.social >= 3 }
        };

        // ============ QUESTION DATABASE ============
        const questions = {
            math: {
                name: "Mathematics", icon: "üìê", from: "#3b82f6", to: "#06b6d4",
                topics: {
                    "Number & Algebra": [
                        { q: "Simplify: 3x + 5x - 2x", opts: ["6x", "8x", "10x", "4x"], ans: 0, exp: "Combine like terms: (3+5-2)x = 6x", diff: "A3-A4" },
                        { q: "What is 2¬≥ √ó 2¬≤?", opts: ["32", "16", "64", "8"], ans: 0, exp: "2¬≥ √ó 2¬≤ = 2‚Åµ = 32", diff: "M5-M6" },
                        { q: "Solve: 2x + 7 = 15", opts: ["x = 4", "x = 8", "x = 11", "x = 3"], ans: 0, exp: "2x = 8, so x = 4", diff: "A3-A4" },
                        { q: "What is 15% of 80?", opts: ["12", "15", "8", "10"], ans: 0, exp: "0.15 √ó 80 = 12", diff: "A3-A4" },
                        { q: "Next term: 2, 6, 18, 54, ...?", opts: ["162", "108", "72", "216"], ans: 0, exp: "√ó3 pattern: 54√ó3=162", diff: "M5-M6" },
                        { q: "Factorise: x¬≤ - 9", opts: ["(x+3)(x-3)", "(x+9)(x-1)", "(x-3)¬≤", "(x+3)¬≤"], ans: 0, exp: "Difference of squares", diff: "E7-E8" },
                        { q: "Ratio boys:girls is 3:5, 24 boys. How many girls?", opts: ["40", "30", "45", "35"], ans: 0, exp: "3 parts=24, so 1 part=8, girls=5√ó8=40", diff: "M5-M6" }
                    ],
                    "Geometry": [
                        { q: "Area of rectangle 8cm √ó 5cm?", opts: ["40 cm¬≤", "26 cm¬≤", "13 cm¬≤", "80 cm¬≤"], ans: 0, exp: "Area = 8√ó5 = 40", diff: "A3-A4" },
                        { q: "Sum of angles in a triangle?", opts: ["180¬∞", "360¬∞", "90¬∞", "270¬∞"], ans: 0, exp: "Always 180¬∞", diff: "A3-A4" },
                        { q: "What type of angle is 135¬∞?", opts: ["Obtuse", "Acute", "Right", "Reflex"], ans: 0, exp: "Between 90¬∞ and 180¬∞", diff: "A3-A4" },
                        { q: "Pythagoras: legs 3cm & 4cm, hypotenuse?", opts: ["5 cm", "7 cm", "6 cm", "12 cm"], ans: 0, exp: "3¬≤+4¬≤=25, ‚àö25=5", diff: "E7-E8" },
                        { q: "Circumference of circle, radius 7cm (œÄ=22/7)?", opts: ["44 cm", "154 cm", "22 cm", "88 cm"], ans: 0, exp: "2œÄr = 2√ó22/7√ó7 = 44", diff: "M5-M6" }
                    ],
                    "Statistics": [
                        { q: "Mean of 4, 7, 8, 9, 12?", opts: ["8", "7", "9", "8.5"], ans: 0, exp: "40√∑5=8", diff: "A3-A4" },
                        { q: "Median of 3, 7, 9, 12, 15?", opts: ["9", "7", "12", "9.2"], ans: 0, exp: "Middle value = 9", diff: "A3-A4" },
                        { q: "Mode of 2, 4, 4, 5, 7, 4, 8?", opts: ["4", "5", "2", "7"], ans: 0, exp: "4 appears most (3√ó)", diff: "A3-A4" },
                        { q: "Range of 15, 22, 8, 31, 19?", opts: ["23", "31", "8", "19"], ans: 0, exp: "31-8=23", diff: "A3-A4" }
                    ]
                }
            },
            english: {
                name: "English ESOL", icon: "üìö", from: "#8b5cf6", to: "#ec4899",
                topics: {
                    "Vocabulary": [
                        { q: "Synonym for 'happy'?", opts: ["Joyful", "Sad", "Angry", "Tired"], ans: 0, exp: "Joyful = happy", diff: "A3-A4" },
                        { q: "Antonym for 'ancient'?", opts: ["Modern", "Old", "Historic", "Traditional"], ans: 0, exp: "Modern = opposite", diff: "A3-A4" },
                        { q: "Which is a noun?", opts: ["Happiness", "Happy", "Happily", "Happier"], ans: 0, exp: "Happiness is a thing", diff: "M5-M6" },
                        { q: "Prefix 'un-' means?", opts: ["Not", "Very", "Before", "After"], ans: 0, exp: "un- = not", diff: "A3-A4" },
                        { q: "Suffix '-ful' means?", opts: ["Full of", "Without", "Before", "Again"], ans: 0, exp: "hopeful = full of hope", diff: "A3-A4" }
                    ],
                    "Grammar": [
                        { q: "Correct sentence?", opts: ["She doesn't like apples.", "She don't like apples.", "She not like apples.", "She no like apples."], ans: 0, exp: "Use 'doesn't' with she/he/it", diff: "A3-A4" },
                        { q: "'The book is _____' (Maria's)", opts: ["hers", "her", "she", "herself"], ans: 0, exp: "Possessive pronoun", diff: "M5-M6" },
                        { q: "Which is compound sentence?", opts: ["I went to the shop, and I bought milk.", "Although it rained.", "The big red car.", "Running quickly."], ans: 0, exp: "Two clauses with 'and'", diff: "E7-E8" },
                        { q: "Past tense of 'go'?", opts: ["went", "goed", "gone", "going"], ans: 0, exp: "Irregular verb", diff: "A3-A4" }
                    ],
                    "Writing": [
                        { q: "Purpose of topic sentence?", opts: ["Introduce main idea", "Conclude essay", "Provide examples", "Cite sources"], ans: 0, exp: "Sets paragraph direction", diff: "M5-M6" },
                        { q: "Which shows contrast?", opts: ["However", "Therefore", "Furthermore", "Similarly"], ans: 0, exp: "However = but", diff: "M5-M6" },
                        { q: "Writing to convince = ?", opts: ["Persuasive", "Narrative", "Descriptive", "Expository"], ans: 0, exp: "Persuade = convince", diff: "A3-A4" }
                    ]
                }
            },
            science: {
                name: "Science", icon: "üî¨", from: "#22c55e", to: "#14b8a6",
                topics: {
                    "Chemistry": [
                        { q: "Chemical symbol for water?", opts: ["H‚ÇÇO", "CO‚ÇÇ", "NaCl", "O‚ÇÇ"], ans: 0, exp: "2 Hydrogen + 1 Oxygen", diff: "A3-A4" },
                        { q: "NOT a sign of chemical reaction?", opts: ["Changing shape", "Colour change", "Gas production", "Heat change"], ans: 0, exp: "Shape change = physical", diff: "M5-M6" },
                        { q: "Three states of matter?", opts: ["Solid, liquid, gas", "Hot, warm, cold", "Big, medium, small", "Hard, soft, flexible"], ans: 0, exp: "Basic states", diff: "A3-A4" },
                        { q: "Where are metals on periodic table?", opts: ["Left side", "Right side", "Top only", "Bottom only"], ans: 0, exp: "Metals on left", diff: "M5-M6" },
                        { q: "What is an atom?", opts: ["Smallest particle of element", "A molecule", "A reaction", "A state"], ans: 0, exp: "Building block of matter", diff: "A3-A4" }
                    ],
                    "Biology": [
                        { q: "Powerhouse of the cell?", opts: ["Mitochondria", "Nucleus", "Cell membrane", "Ribosome"], ans: 0, exp: "Makes energy (ATP)", diff: "A3-A4" },
                        { q: "Plants make food by?", opts: ["Photosynthesis", "Respiration", "Digestion", "Fermentation"], ans: 0, exp: "Light + CO‚ÇÇ + H‚ÇÇO", diff: "A3-A4" },
                        { q: "Function of nucleus?", opts: ["Controls cell, has DNA", "Makes energy", "Makes proteins", "Stores water"], ans: 0, exp: "Control center", diff: "M5-M6" },
                        { q: "What is an ecosystem?", opts: ["Living things + environment", "Single organism", "Only plants", "Only animals"], ans: 0, exp: "All living + non-living together", diff: "M5-M6" }
                    ],
                    "Physics": [
                        { q: "Unit of force?", opts: ["Newton", "Joule", "Watt", "Metre"], ans: 0, exp: "Named after Isaac Newton", diff: "A3-A4" },
                        { q: "Moving car has what energy?", opts: ["Kinetic", "Potential", "Chemical", "Nuclear"], ans: 0, exp: "Kinetic = motion", diff: "A3-A4" },
                        { q: "Light through prism does what?", opts: ["Separates into colours", "Gets brighter", "Disappears", "Becomes laser"], ans: 0, exp: "Creates spectrum", diff: "M5-M6" }
                    ]
                }
            },
            social: {
                name: "Social Science", icon: "üåè", from: "#f97316", to: "#ef4444",
                topics: {
                    "NZ History": [
                        { q: "Treaty of Waitangi signed?", opts: ["1840", "1800", "1900", "1776"], ans: 0, exp: "6 February 1840", diff: "A3-A4" },
                        { q: "First NZ settlers?", opts: ["MƒÅori", "British", "Dutch", "Australian"], ans: 0, exp: "Polynesian settlers ~1300AD", diff: "A3-A4" },
                        { q: "Treaty principles?", opts: ["Partnership, Protection, Participation", "Peace, Power, Prosperity", "Land, Law, Liberty", "King, Country, Crown"], ans: 0, exp: "The 3 P's", diff: "M5-M6" }
                    ],
                    "Geography": [
                        { q: "NZ earthquakes caused by?", opts: ["Convergent boundary", "Divergent boundary", "Transform boundary", "None"], ans: 0, exp: "Pacific + Australian plates", diff: "M5-M6" },
                        { q: "What is sustainability?", opts: ["Meet needs without harming future", "Use resources quickly", "Ignore problems", "Build more"], ans: 0, exp: "Think of future generations", diff: "A3-A4" },
                        { q: "Main cause of climate change?", opts: ["Greenhouse gases", "Moon changes", "Volcanoes only", "Ocean currents only"], ans: 0, exp: "Human CO‚ÇÇ emissions", diff: "M5-M6" }
                    ],
                    "Civics": [
                        { q: "NZ government type?", opts: ["Parliamentary democracy", "Presidential republic", "Absolute monarchy", "Dictatorship"], ans: 0, exp: "Elected parliament", diff: "A3-A4" },
                        { q: "NZ voting age?", opts: ["18", "16", "21", "25"], ans: 0, exp: "18 years old", diff: "A3-A4" }
                    ]
                }
            }
        };

        // ============ GRADE SYSTEM ============
        const grades = {
            N0: { min: 0, max: 9, label: "Not Achieved", color: "#ef4444", emoji: "üòî" },
            N1: { min: 10, max: 19, label: "Not Achieved", color: "#ef4444", emoji: "üòï" },
            N2: { min: 20, max: 39, label: "Not Achieved", color: "#f97316", emoji: "ü§î" },
            A3: { min: 40, max: 49, label: "Achieved", color: "#eab308", emoji: "üòä" },
            A4: { min: 50, max: 59, label: "Achieved", color: "#84cc16", emoji: "üôÇ" },
            M5: { min: 60, max: 69, label: "Merit", color: "#22c55e", emoji: "üòÑ" },
            M6: { min: 70, max: 79, label: "Merit", color: "#14b8a6", emoji: "üòÉ" },
            E7: { min: 80, max: 89, label: "Excellence", color: "#3b82f6", emoji: "üåü" },
            E8: { min: 90, max: 100, label: "Excellence", color: "#8b5cf6", emoji: "üèÜ" }
        };

        function getGrade(pct) {
            for (const [g, d] of Object.entries(grades)) {
                if (pct >= d.min && pct <= d.max) return { grade: g, ...d };
            }
            return { grade: "N0", ...grades.N0 };
        }

        // ============ APP STATE ============
        let state = JSON.parse(localStorage.getItem('rangiData') || 'null') || {
            name: '', xp: 0, streak: 0, exams: 0, perfect: 0, excellence: 0, fastExams: 0,
            subjects: { math: 0, english: 0, science: 0, social: 0 },
            history: [], badges: [], lastStudyDate: null, lastBackup: null
        };

        let view = 'welcome';
        let currentExam = null;
        let examState = { q: 0, answers: [], time: 180, feedback: false, selected: null };
        let showSyncModal = false;
        let syncTab = 'export';
        let syncMessage = null;
        let newBadges = []; // Track newly earned badges for animation

        // ============ STREAK LOGIC ============
        function updateStreak() {
            const today = new Date().toDateString();
            const lastDate = state.lastStudyDate ? new Date(state.lastStudyDate).toDateString() : null;
            
            if (lastDate === today) {
                // Already studied today
                return;
            }
            
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (lastDate === yesterday.toDateString()) {
                // Studied yesterday, increment streak
                state.streak++;
            } else if (lastDate !== today) {
                // Missed a day, reset streak
                state.streak = 1;
            }
            
            state.lastStudyDate = new Date().toISOString();
        }

        // ============ BADGE CHECKING ============
        function checkBadges() {
            newBadges = [];
            for (const [id, badge] of Object.entries(badgesDef)) {
                if (!state.badges.includes(id) && badge.check(state)) {
                    state.badges.push(id);
                    newBadges.push(id);
                }
            }
            return newBadges;
        }

        // ============ SAVE / EXPORT / IMPORT ============
        function save() { 
            localStorage.setItem('rangiData', JSON.stringify(state)); 
        }

        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const textarea = document.getElementById('exportData');
            if (textarea) {
                textarea.value = dataStr;
                textarea.select();
                document.execCommand('copy');
                syncMessage = { type: 'success', text: '‚úÖ Data copied to clipboard!' };
                state.lastBackup = new Date().toISOString();
                save();
                render();
            }
        }

        function downloadData() {
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rangitoto-backup-${state.name}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            state.lastBackup = new Date().toISOString();
            save();
            syncMessage = { type: 'success', text: '‚úÖ Backup downloaded!' };
            render();
        }

        function importData() {
            const textarea = document.getElementById('importData');
            if (textarea && textarea.value.trim()) {
                try {
                    const imported = JSON.parse(textarea.value.trim());
                    if (imported.name && typeof imported.xp === 'number') {
                        state = { ...state, ...imported };
                        save();
                        syncMessage = { type: 'success', text: '‚úÖ Data imported successfully!' };
                        showSyncModal = false;
                        render();
                    } else {
                        syncMessage = { type: 'error', text: '‚ùå Invalid data format.' };
                        render();
                    }
                } catch (e) {
                    syncMessage = { type: 'error', text: '‚ùå Could not parse data.' };
                    render();
                }
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('importData').value = e.target.result;
                };
                reader.readAsText(file);
            }
        }

        // ============ RENDER FUNCTIONS ============
        function render() {
            const app = document.getElementById('app');
            let html = '';
            
            if (showSyncModal) html += syncModalHTML();
            
            if (!state.name) {
                html += welcomeHTML();
            } else if (currentExam) {
                html += examHTML();
            } else {
                html += mainHTML();
            }
            
            app.innerHTML = html;
        }

        function welcomeHTML() {
            return `
                <div class="glass text-center bounce-in" style="max-width:500px;margin:50px auto;">
                    <div class="text-6xl mb-4 floating">üéì</div>
                    <h1 class="text-4xl font-bold mb-4">Rangitoto</h1>
                    <h2 class="text-2xl text-purple mb-6">Year 9 Review Hub</h2>
                    <p class="text-gray mb-6">Get ready to review your subjects with fun quizzes!</p>
                    <input class="input" type="text" id="nameInput" placeholder="Enter your name...">
                    <button class="btn" onclick="startApp()">Start Learning! üöÄ</button>
                    
                    <div style="border-top:1px solid rgba(255,255,255,0.2);padding-top:20px;margin-top:20px;">
                        <p class="text-gray text-sm mb-4">üìÇ Have a backup from another device?</p>
                        <button class="btn btn-secondary" onclick="showSyncModal=true;syncTab='import';render()">
                            Import Backup Data
                        </button>
                    </div>
                </div>
            `;
        }

        function syncModalHTML() {
            return `
                <div class="modal-overlay" onclick="if(event.target===this){showSyncModal=false;syncMessage=null;render();}">
                    <div class="modal">
                        <h2 class="text-2xl font-bold mb-4">üíæ Backup & Sync</h2>
                        
                        <div class="tabs">
                            <button class="tab ${syncTab === 'export' ? 'active' : ''}" onclick="syncTab='export';syncMessage=null;render()">üì§ Export</button>
                            <button class="tab ${syncTab === 'import' ? 'active' : ''}" onclick="syncTab='import';syncMessage=null;render()">üì• Import</button>
                        </div>
                        
                        ${syncMessage ? `<div class="alert alert-${syncMessage.type === 'success' ? 'success' : 'error'} mb-4">${syncMessage.text}</div>` : ''}
                        
                        ${syncTab === 'export' ? `
                            <button class="btn btn-green" onclick="downloadData()">üì• Download Backup File</button>
                            <p class="text-gray text-sm text-center mb-4">‚Äî or copy as text ‚Äî</p>
                            <textarea class="input" id="exportData" readonly>${JSON.stringify(state, null, 2)}</textarea>
                            <button class="btn btn-blue" onclick="exportData()">üìã Copy to Clipboard</button>
                        ` : `
                            <div class="alert alert-warning mb-4"><p class="font-bold text-orange">‚ö†Ô∏è Warning: This will replace your current data!</p></div>
                            <input type="file" accept=".json" onchange="handleFileUpload(event)" class="input" style="padding:10px;">
                            <p class="text-gray text-sm text-center mb-2">‚Äî or paste data ‚Äî</p>
                            <textarea class="input" id="importData" placeholder="Paste backup data here..."></textarea>
                            <button class="btn btn-orange" onclick="importData()">üì• Import Data</button>
                        `}
                        
                        <button class="btn btn-secondary mt-4" onclick="showSyncModal=false;syncMessage=null;render()">Close</button>
                    </div>
                </div>
            `;
        }

        function startApp() {
            const name = document.getElementById('nameInput').value.trim();
            if (name) { 
                state.name = name; 
                save(); 
                render(); 
            }
        }

        function mainHTML() {
            const health = Math.min(100, Math.round((state.exams / 3) * 80 + state.streak * 3));
            const healthClass = health >= 60 ? 'health-good' : health >= 30 ? 'health-warning' : 'health-danger';
            
            return `
                <div class="header">
                    <div class="flex items-center gap-4">
                        <span class="text-4xl floating">üéì</span>
                        <div>
                            <h1 class="text-xl font-bold">Kia ora, ${state.name}!</h1>
                            <span class="text-yellow">‚ö° ${state.xp} XP</span>
                            ${state.streak > 0 ? `<span class="text-gray"> | üî• ${state.streak} day streak</span>` : ''}
                        </div>
                    </div>
                    <div class="flex gap-2 items-center flex-wrap">
                        <button class="btn btn-small btn-secondary" onclick="showSyncModal=true;syncTab='export';render()">üíæ</button>
                        <div class="health-bar ${healthClass}">Health: ${health}%</div>
                    </div>
                </div>
                
                <div class="nav">
                    <button class="nav-btn ${view === 'dashboard' ? 'active' : ''}" onclick="setView('dashboard')">üè† Home</button>
                    <button class="nav-btn ${view === 'subjects' ? 'active' : ''}" onclick="setView('subjects')">üìö Subjects</button>
                    <button class="nav-btn ${view === 'badges' ? 'active' : ''}" onclick="setView('badges')">üèÖ Badges</button>
                    <button class="nav-btn ${view === 'stats' ? 'active' : ''}" onclick="setView('stats')">üìä Stats</button>
                </div>
                
                ${view === 'dashboard' ? dashboardHTML() : view === 'subjects' ? subjectsHTML() : view === 'badges' ? badgesHTML() : statsHTML()}
            `;
        }

        function setView(v) { view = v; render(); }

        function dashboardHTML() {
            const earnedCount = state.badges.length;
            const totalCount = Object.keys(badgesDef).length;
            
            return `
                <div class="glass">
                    <h2 class="text-xl font-bold mb-4">‚ö° Quick Start</h2>
                    <div class="grid grid-2 gap-4">
                        ${Object.entries(questions).map(([k, v]) => `
                            <button class="subject-card" style="--from:${v.from};--to:${v.to}" onclick="setView('subjects')">
                                <div class="icon">${v.icon}</div>
                                <div class="font-bold">${v.name}</div>
                                <div class="text-sm" style="opacity:0.7">${Object.keys(v.topics).length} topics</div>
                            </button>
                        `).join('')}
                    </div>
                </div>
                
                <div class="glass">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">üèÖ Badges</h2>
                        <span class="text-gray">${earnedCount}/${totalCount} earned</span>
                    </div>
                    <div class="flex gap-3 flex-wrap">
                        ${state.badges.slice(0, 6).map(id => `
                            <div class="text-center" title="${badgesDef[id].name}">
                                <span style="font-size:32px">${badgesDef[id].icon}</span>
                            </div>
                        `).join('')}
                        ${state.badges.length === 0 ? '<p class="text-gray">Complete exams to earn badges!</p>' : ''}
                        ${state.badges.length > 6 ? `<span class="text-gray text-sm">+${state.badges.length - 6} more</span>` : ''}
                    </div>
                    <button class="btn btn-small btn-secondary mt-4" onclick="setView('badges')">View All Badges ‚Üí</button>
                </div>
                
                <div class="glass">
                    <h2 class="text-xl font-bold mb-4">üìä Progress</h2>
                    <div class="stats-row"><span>Total XP</span><span class="text-yellow font-bold">‚ö° ${state.xp}</span></div>
                    <div class="stats-row"><span>Exams Done</span><span class="text-green font-bold">‚úÖ ${state.exams}</span></div>
                    <div class="stats-row"><span>Current Streak</span><span style="color:#f97316" class="font-bold">üî• ${state.streak} days</span></div>
                    <div class="stats-row"><span>Excellence Grades</span><span class="font-bold" style="color:#8b5cf6">üèÜ ${state.excellence}</span></div>
                </div>
            `;
        }

        function badgesHTML() {
            const earnedCount = state.badges.length;
            const totalCount = Object.keys(badgesDef).length;
            
            return `
                <div class="glass">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">üèÖ All Badges</h2>
                        <span class="badge-tag badge-purple">${earnedCount}/${totalCount}</span>
                    </div>
                    
                    <div class="grid grid-3 gap-4">
                        ${Object.entries(badgesDef).map(([id, badge]) => {
                            const earned = state.badges.includes(id);
                            const isNew = newBadges.includes(id);
                            return `
                                <div class="badge-card ${earned ? 'earned' : 'locked'} ${isNew ? 'new-badge' : ''}">
                                    <span class="badge-icon">${badge.icon}</span>
                                    <div class="badge-name">${badge.name}</div>
                                    <div class="badge-desc">${badge.desc}</div>
                                    ${!earned ? `<div class="badge-progress"><span class="text-xs text-gray">üîí Locked</span></div>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <div class="glass">
                    <h2 class="text-xl font-bold mb-4">üí° Tips to Earn More</h2>
                    <ul style="padding-left:20px;line-height:2;">
                        ${!state.badges.includes('first_steps') ? '<li>Complete your first exam to get <b>First Steps</b> üéØ</li>' : ''}
                        ${!state.badges.includes('on_fire') ? '<li>Study 3 days in a row for <b>On Fire</b> üî•</li>' : ''}
                        ${!state.badges.includes('perfectionist') ? '<li>Get 100% on any exam for <b>Perfectionist</b> üíØ</li>' : ''}
                        ${!state.badges.includes('speed_demon') ? '<li>Finish an exam in under 2 minutes for <b>Speed Demon</b> ‚ö°</li>' : ''}
                        ${state.badges.length >= 4 ? '<li class="text-green">Great progress! Keep going! üöÄ</li>' : ''}
                    </ul>
                </div>
            `;
        }

        function subjectsHTML() {
            return `
                <div class="glass">
                    <h2 class="text-xl font-bold mb-4">üìö Choose a Subject</h2>
                    ${Object.entries(questions).map(([k, v]) => `
                        <div class="subject-card mb-4" style="--from:${v.from};--to:${v.to};cursor:default">
                            <div class="flex items-center gap-4">
                                <span class="text-4xl">${v.icon}</span>
                                <div>
                                    <div class="font-bold">${v.name}</div>
                                    <div class="text-sm" style="opacity:0.7">${Object.keys(v.topics).length} topics ‚Ä¢ ${state.subjects[k]} exams done</div>
                                </div>
                            </div>
                            <div>
                                ${Object.entries(v.topics).map(([topic, qs]) => `
                                    <button class="topic-btn" onclick="startExam('${k}','${topic}')">
                                        <span>${topic}</span>
                                        <span class="text-sm text-gray">${qs.length} questions ‚Üí</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function statsHTML() {
            return `
                <div class="glass">
                    <h2 class="text-xl font-bold mb-4">üìä Detailed Stats</h2>
                    <div class="stats-row"><span>Total XP</span><span class="text-yellow font-bold">‚ö° ${state.xp}</span></div>
                    <div class="stats-row"><span>Exams Completed</span><span class="text-green font-bold">‚úÖ ${state.exams}</span></div>
                    <div class="stats-row"><span>Current Streak</span><span style="color:#f97316" class="font-bold">üî• ${state.streak} days</span></div>
                    <div class="stats-row"><span>Perfect Scores (100%)</span><span class="text-purple font-bold">üíØ ${state.perfect}</span></div>
                    <div class="stats-row"><span>Excellence Grades</span><span class="font-bold" style="color:#8b5cf6">üèÜ ${state.excellence}</span></div>
                    <div class="stats-row"><span>Fast Exams (<2min)</span><span class="text-blue font-bold">‚ö° ${state.fastExams || 0}</span></div>
                    <div class="stats-row"><span>Badges Earned</span><span class="font-bold">üèÖ ${state.badges.length}/${Object.keys(badgesDef).length}</span></div>
                    
                    <h3 class="text-lg font-bold mb-2" style="margin-top:20px">By Subject</h3>
                    ${Object.entries(questions).map(([k, v]) => `
                        <div class="stats-row"><span>${v.icon} ${v.name}</span><span class="font-bold">${state.subjects[k]} exams</span></div>
                    `).join('')}
                </div>
                
                ${state.history.length > 0 ? `
                <div class="glass">
                    <h2 class="text-xl font-bold mb-4">üìú Recent Exams</h2>
                    ${state.history.slice(0, 5).map(h => `
                        <div class="stats-row">
                            <span>${questions[h.subject].icon} ${h.topic}</span>
                            <span><span class="badge-tag" style="background:${getGrade(h.score).color}">${h.grade}</span> ${h.score}%</span>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
            `;
        }

        function startExam(subject, topic) {
            const qs = questions[subject].topics[topic];
            const shuffled = [...qs].sort(() => Math.random() - 0.5).slice(0, Math.min(5, qs.length));
            currentExam = { subject, topic, questions: shuffled, startTime: Date.now() };
            examState = { q: 0, answers: [], time: 180, feedback: false, selected: null };
            render();
            startTimer();
        }

        let timerInterval;
        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (examState.time > 0 && !examState.feedback) {
                    examState.time--;
                    const timerEl = document.getElementById('timer');
                    if (timerEl) {
                        timerEl.textContent = `‚è±Ô∏è ${Math.floor(examState.time/60)}:${(examState.time%60).toString().padStart(2,'0')}`;
                        if (examState.time < 30) timerEl.className = 'font-bold text-red';
                    }
                }
            }, 1000);
        }

        function examHTML() {
            const q = currentExam.questions[examState.q];
            const progress = ((examState.q + 1) / currentExam.questions.length) * 100;
            const sub = questions[currentExam.subject];
            
            return `
                <div class="glass">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">${sub.icon}</span>
                            <span class="font-bold">${currentExam.topic}</span>
                        </div>
                        <span id="timer" class="font-bold ${examState.time < 30 ? 'text-red' : ''}">
                            ‚è±Ô∏è ${Math.floor(examState.time/60)}:${(examState.time%60).toString().padStart(2,'0')}
                        </span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>
                    <p class="text-gray text-sm">Question ${examState.q + 1} of ${currentExam.questions.length}</p>
                </div>
                
                <div class="glass bounce-in">
                    <span class="badge-tag ${q.diff.includes('E') ? 'badge-purple' : q.diff.includes('M') ? 'badge-green' : 'badge-yellow'}">${q.diff}</span>
                    <h2 class="text-xl font-bold" style="margin:15px 0 25px">${q.q}</h2>
                    
                    ${q.opts.map((opt, i) => {
                        let cls = 'option-btn';
                        if (examState.feedback) {
                            if (i === q.ans) cls += ' correct';
                            else if (i === examState.selected) cls += ' wrong';
                        }
                        return `<button class="${cls}" ${examState.feedback ? 'disabled' : ''} onclick="answer(${i})">${String.fromCharCode(65+i)}. ${opt}</button>`;
                    }).join('')}
                    
                    ${examState.feedback ? `
                        <div class="glass" style="margin-top:20px;background:${examState.selected === q.ans ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)'}">
                            <p class="font-bold ${examState.selected === q.ans ? 'text-green' : 'text-red'}">
                                ${examState.selected === q.ans ? '‚úÖ Correct!' : '‚ùå Not quite!'}
                            </p>
                            <p class="text-purple text-sm" style="margin-top:8px">üí° ${q.exp}</p>
                        </div>
                    ` : ''}
                </div>
                
                <button onclick="exitExam()" class="text-gray" style="background:none;border:none;cursor:pointer;margin-top:10px">‚Üê Exit Quiz</button>
            `;
        }

        function answer(i) {
            if (examState.feedback) return;
            examState.selected = i;
            examState.feedback = true;
            render();
            
            setTimeout(() => {
                examState.answers.push(i);
                examState.feedback = false;
                examState.selected = null;
                
                if (examState.q < currentExam.questions.length - 1) {
                    examState.q++;
                    render();
                } else {
                    finishExam();
                }
            }, 1500);
        }

        function finishExam() {
            clearInterval(timerInterval);
            let correct = 0;
            currentExam.questions.forEach((q, i) => { if (examState.answers[i] === q.ans) correct++; });
            
            const score = Math.round((correct / currentExam.questions.length) * 100);
            const gradeInfo = getGrade(score);
            const timeTaken = Math.floor((Date.now() - currentExam.startTime) / 1000);
            const isFast = timeTaken < 120;
            const xp = Math.round(score * 2 + (isFast ? 50 : 0));
            
            // Update state
            state.xp += xp;
            state.exams++;
            state.subjects[currentExam.subject]++;
            if (score === 100) state.perfect++;
            if (score >= 80) state.excellence++;
            if (isFast) state.fastExams = (state.fastExams || 0) + 1;
            
            // Update streak
            updateStreak();
            
            // Add to history
            state.history.unshift({
                subject: currentExam.subject,
                topic: currentExam.topic,
                score, grade: gradeInfo.grade, xp,
                date: new Date().toISOString()
            });
            state.history = state.history.slice(0, 20);
            
            // Check for new badges
            const earned = checkBadges();
            
            save();
            showResults(score, gradeInfo, xp, timeTaken, correct, earned);
        }

        function showResults(score, gradeInfo, xp, timeTaken, correct, newlyEarned) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="glass text-center bounce-in">
                    <div class="text-6xl mb-4 ${newlyEarned.length > 0 ? 'celebrate' : ''}">${gradeInfo.emoji}</div>
                    <h1 class="text-4xl font-bold mb-4">Exam Complete!</h1>
                    
                    <div class="flex justify-center gap-4 mb-6" style="flex-wrap:wrap">
                        <div class="text-center">
                            <div class="text-4xl font-bold" style="color:${gradeInfo.color}">${score}%</div>
                            <div class="text-gray">Score</div>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-bold" style="color:${gradeInfo.color}">${gradeInfo.grade}</div>
                            <div class="text-gray">${gradeInfo.label}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-bold text-yellow">+${xp}</div>
                            <div class="text-gray">XP Earned</div>
                        </div>
                    </div>
                    
                    <p class="text-gray mb-4">Completed in ${Math.floor(timeTaken/60)}:${(timeTaken%60).toString().padStart(2,'0')}</p>
                    <p class="mb-6">${correct} of ${currentExam.questions.length} correct</p>
                    
                    ${newlyEarned.length > 0 ? `
                        <div class="glass mb-6" style="background:linear-gradient(135deg, rgba(139,92,246,0.3), rgba(236,72,153,0.3));">
                            <h3 class="text-xl font-bold mb-4">üéâ New Badge${newlyEarned.length > 1 ? 's' : ''} Earned!</h3>
                            <div class="flex justify-center gap-4 flex-wrap">
                                ${newlyEarned.map(id => `
                                    <div class="text-center new-badge">
                                        <span style="font-size:48px;display:block">${badgesDef[id].icon}</span>
                                        <span class="font-bold">${badgesDef[id].name}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <button class="btn" onclick="backToMain()">Continue Learning üöÄ</button>
                </div>
                
                <div class="glass">
                    <h2 class="text-xl font-bold mb-4">üìù Review Answers</h2>
                    ${currentExam.questions.map((q, i) => {
                        const isCorrect = examState.answers[i] === q.ans;
                        return `
                            <div class="glass mb-4" style="background:${isCorrect ? 'rgba(34,197,94,0.1)' : 'rgba(239,68,68,0.1)'}">
                                <div class="flex gap-2">
                                    <span class="text-2xl">${isCorrect ? '‚úÖ' : '‚ùå'}</span>
                                    <div>
                                        <p class="font-bold">${q.q}</p>
                                        <p class="text-sm ${isCorrect ? 'text-green' : 'text-red'}">
                                            Your answer: ${q.opts[examState.answers[i]] || 'None'}
                                        </p>
                                        ${!isCorrect ? `<p class="text-green text-sm">Correct: ${q.opts[q.ans]}</p>` : ''}
                                        <p class="text-purple text-sm" style="margin-top:8px">üí° ${q.exp}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function backToMain() {
            currentExam = null;
            newBadges = [];
            view = 'dashboard';
            render();
        }

        function exitExam() {
            clearInterval(timerInterval);
            currentExam = null;
            view = 'dashboard';
            render();
        }

        // ============ INITIALIZE ============
        render();
    </script>
</body>
</html>
