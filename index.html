<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rangitoto Year 9 Review Hub</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%); min-height: 100vh; color: white; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .glass { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 25px; margin-bottom: 20px; }
        .btn { background: linear-gradient(135deg, #8b5cf6, #ec4899); border: none; color: white; padding: 15px 30px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; width: 100%; margin-bottom: 10px; }
        .btn:hover { transform: scale(1.02); box-shadow: 0 10px 30px rgba(139,92,246,0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: rgba(255,255,255,0.2); }
        .btn-small { padding: 10px 16px; font-size: 14px; width: auto; }
        .btn-green { background: linear-gradient(135deg, #22c55e, #14b8a6); }
        .btn-blue { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
        .btn-orange { background: linear-gradient(135deg, #f97316, #eab308); }
        .input { width: 100%; padding: 15px 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 16px; margin-bottom: 15px; }
        .input::placeholder { color: rgba(255,255,255,0.5); }
        .input:focus { outline: none; border-color: #8b5cf6; }
        textarea.input { min-height: 100px; resize: vertical; font-family: monospace; font-size: 12px; }
        .text-center { text-align: center; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-6 { margin-bottom: 24px; }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .text-6xl { font-size: 60px; }
        .text-5xl { font-size: 48px; }
        .text-4xl { font-size: 36px; }
        .text-3xl { font-size: 30px; }
        .text-2xl { font-size: 24px; }
        .text-xl { font-size: 20px; }
        .text-lg { font-size: 18px; }
        .text-sm { font-size: 14px; }
        .text-xs { font-size: 12px; }
        .text-gray { color: rgba(255,255,255,0.6); }
        .text-yellow { color: #fbbf24; }
        .text-green { color: #34d399; }
        .text-red { color: #f87171; }
        .text-purple { color: #c084fc; }
        .text-blue { color: #60a5fa; }
        .text-orange { color: #fb923c; }
        .font-bold { font-weight: bold; }
        .hidden { display: none; }
        .flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .gap-4 { gap: 16px; }
        .grid { display: grid; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-7 { grid-template-columns: repeat(7, 1fr); }
        .subject-card { background: linear-gradient(135deg, var(--from), var(--to)); padding: 20px; border-radius: 16px; cursor: pointer; transition: transform 0.2s; text-align: left; border: none; color: white; width: 100%; }
        .subject-card:hover { transform: translateY(-5px); }
        .subject-card .icon { font-size: 40px; margin-bottom: 10px; }
        .option-btn { background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: white; padding: 15px 20px; border-radius: 12px; cursor: pointer; text-align: left; transition: all 0.2s; margin-bottom: 10px; display: block; width: 100%; font-size: 16px; }
        .option-btn:hover { background: rgba(139,92,246,0.3); transform: translateX(5px); }
        .option-btn.correct { background: rgba(34,197,94,0.3); border-color: #22c55e; }
        .option-btn.wrong { background: rgba(239,68,68,0.3); border-color: #ef4444; }
        .progress-bar { height: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #8b5cf6, #ec4899); border-radius: 5px; transition: width 0.5s ease-out; }
        .progress-fill.green { background: linear-gradient(90deg, #22c55e, #14b8a6); }
        .stats-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .badge-tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .badge-green { background: #22c55e; }
        .badge-yellow { background: #eab308; }
        .badge-purple { background: #8b5cf6; }
        .badge-blue { background: #3b82f6; }
        .nav { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 10px 16px; border-radius: 10px; cursor: pointer; font-size: 14px; }
        .nav-btn.active { background: linear-gradient(135deg, #8b5cf6, #ec4899); }
        .header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .health-bar { padding: 8px 16px; border-radius: 10px; font-weight: bold; }
        .health-good { background: linear-gradient(135deg, #22c55e, #34d399); }
        .health-warning { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
        .health-danger { background: linear-gradient(135deg, #ef4444, #f87171); }
        .alert { padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .alert-info { background: rgba(59,130,246,0.2); border: 1px solid rgba(59,130,246,0.5); }
        .alert-success { background: rgba(34,197,94,0.2); border: 1px solid rgba(34,197,94,0.5); }
        .alert-warning { background: rgba(245,158,11,0.2); border: 1px solid rgba(245,158,11,0.5); }
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 10px 10px 0 0; cursor: pointer; }
        .tab.active { background: rgba(255,255,255,0.2); }
        
        /* Calendar Styles */
        .week-card { background: rgba(255,255,255,0.08); border-radius: 16px; padding: 20px; margin-bottom: 15px; border-left: 4px solid var(--accent); }
        .week-card.current { background: rgba(139,92,246,0.2); border-left-color: #8b5cf6; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .calendar-day-header { text-align: center; font-size: 11px; color: rgba(255,255,255,0.5); padding: 5px; font-weight: bold; }
        .calendar-day { 
            aspect-ratio: 1; 
            border-radius: 10px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: all 0.2s; 
            position: relative;
            background: rgba(255,255,255,0.05);
            border: 2px solid transparent;
            min-height: 60px;
        }
        .calendar-day:hover { transform: scale(1.08); background: rgba(255,255,255,0.15); }
        .calendar-day.today { border: 2px solid #fbbf24; box-shadow: 0 0 15px rgba(251,191,36,0.5); }
        .calendar-day.completed { background: linear-gradient(135deg, rgba(34,197,94,0.4), rgba(20,184,166,0.4)); border-color: #22c55e; }
        .calendar-day.partial { background: linear-gradient(135deg, rgba(251,191,36,0.4), rgba(249,115,22,0.4)); border-color: #f59e0b; }
        .calendar-day.future { opacity: 0.4; }
        .calendar-day.past-incomplete { background: linear-gradient(135deg, rgba(239,68,68,0.3), rgba(239,68,68,0.2)); border-color: rgba(239,68,68,0.6); }
        .calendar-day.rest-day { background: rgba(139,92,246,0.3); }
        .calendar-day .day-num { font-size: 14px; font-weight: bold; }
        .calendar-day .day-icon { font-size: 18px; margin-top: 2px; }
        .calendar-day .day-progress { position: absolute; bottom: 3px; left: 3px; right: 3px; height: 3px; background: rgba(255,255,255,0.2); border-radius: 2px; overflow: hidden; }
        .calendar-day .day-progress-fill { height: 100%; background: #22c55e; border-radius: 2px; }
        .calendar-day.disabled { pointer-events: none; opacity: 0.2; }
        
        .day-task-card { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; margin-bottom: 10px; }
        .task-status { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .status-complete { background: #22c55e; }
        .status-partial { background: #f59e0b; }
        .status-pending { background: rgba(255,255,255,0.2); }
        
        .badge-card { background: rgba(255,255,255,0.1); border-radius: 16px; padding: 15px; text-align: center; transition: all 0.3s; position: relative; overflow: hidden; }
        .badge-card.earned { background: linear-gradient(135deg, rgba(139,92,246,0.3), rgba(236,72,153,0.3)); border: 2px solid rgba(139,92,246,0.5); }
        .badge-card.locked { opacity: 0.5; filter: grayscale(0.8); }
        .badge-card .badge-icon { font-size: 32px; margin-bottom: 6px; display: block; }
        .badge-card .badge-name { font-weight: bold; font-size: 11px; margin-bottom: 3px; }
        .badge-card .badge-desc { font-size: 9px; color: rgba(255,255,255,0.6); }
        .badge-card.earned::after { content: '‚úì'; position: absolute; top: 6px; right: 6px; background: #22c55e; color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        
        .topic-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 12px 16px; border-radius: 10px; cursor: pointer; width: 100%; text-align: left; margin-top: 8px; display: flex; justify-content: space-between; }
        .topic-btn:hover { background: rgba(255,255,255,0.2); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal { background: linear-gradient(135deg, #1e1b4b, #312e81); border-radius: 20px; padding: 30px; max-width: 550px; width: 100%; max-height: 90vh; overflow-y: auto; }
        
        @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .floating { animation: float 3s ease-in-out infinite; }
        @keyframes bounce { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        .bounce-in { animation: bounce 0.5s cubic-bezier(0.68,-0.55,0.265,1.55); }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 10px rgba(251,191,36,0.4); } 50% { box-shadow: 0 0 25px rgba(251,191,36,0.8); } }
        .today-glow { animation: glow 2s ease-in-out infinite; }
        
        @media (max-width: 700px) { 
            .grid-2 { grid-template-columns: 1fr; } 
            .grid-3 { grid-template-columns: repeat(3, 1fr); } 
            .header { flex-direction: column; align-items: flex-start; } 
            .calendar-day { min-height: 50px; }
            .calendar-day .day-num { font-size: 12px; }
            .calendar-day .day-icon { font-size: 14px; }
            .nav-btn { padding: 8px 12px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="container" id="app"></div>

    <script>
        // ============ 6-WEEK STUDY PLAN ============
        const PLAN_START = new Date('2025-12-06');
        const PLAN_END = new Date('2026-01-17');
        const DAILY_GOAL = 2;
        
        const weeklyPlan = [
            { week: 1, name: "Week 1", dates: "Dec 6-12", subject: "math", topic: "Number & Algebra", icon: "üìê", color: { from: "#3b82f6", to: "#06b6d4" } },
            { week: 2, name: "Week 2", dates: "Dec 13-19", subject: "english", topic: "Vocabulary", icon: "üìö", color: { from: "#8b5cf6", to: "#ec4899" } },
            { week: 3, name: "Week 3", dates: "Dec 20-26", subject: "math", topic: "Geometry", icon: "üìê", color: { from: "#3b82f6", to: "#06b6d4" }, holiday: true },
            { week: 4, name: "Week 4", dates: "Dec 27-Jan 2", subject: "science", topic: "Chemistry", icon: "üî¨", color: { from: "#22c55e", to: "#14b8a6" }, holiday: true },
            { week: 5, name: "Week 5", dates: "Jan 3-9", subject: "english", topic: "Grammar", icon: "üìö", color: { from: "#8b5cf6", to: "#ec4899" } },
            { week: 6, name: "Week 6", dates: "Jan 10-17", subject: "all", topic: "Final Review", icon: "üéØ", color: { from: "#f97316", to: "#ef4444" } }
        ];
        
        const restDays = ['2025-12-25', '2026-01-01'];
        
        function generateDailyPlan() {
            const days = [];
            let current = new Date(PLAN_START);
            let dayIndex = 0;
            
            while (current <= PLAN_END) {
                const dateStr = current.toISOString().split('T')[0];
                const weekNum = Math.floor(dayIndex / 7);
                const weekPlan = weeklyPlan[Math.min(weekNum, 5)];
                const isRest = restDays.includes(dateStr);
                
                days.push({
                    date: dateStr,
                    dayIndex,
                    week: weekNum + 1,
                    weekPlan,
                    subject: isRest ? null : weekPlan.subject,
                    topic: isRest ? null : weekPlan.topic,
                    icon: isRest ? 'üéÑ' : weekPlan.icon,
                    isRest,
                    goal: isRest ? 0 : (weekPlan.holiday ? 1 : DAILY_GOAL),
                    dayOfWeek: current.getDay()
                });
                
                current.setDate(current.getDate() + 1);
                dayIndex++;
            }
            return days;
        }
        
        const dailyPlan = generateDailyPlan();

        // ============ BADGES ============
        const badgesDef = {
            first_steps: { icon: 'üéØ', name: 'First Steps', desc: 'Complete 1 exam', check: s => s.exams >= 1 },
            on_fire: { icon: 'üî•', name: 'On Fire', desc: '3-day streak', check: s => s.streak >= 3 },
            week_warrior: { icon: '‚öîÔ∏è', name: 'Week Warrior', desc: '7-day streak', check: s => s.streak >= 7 },
            perfectionist: { icon: 'üíØ', name: 'Perfectionist', desc: 'Get 100%', check: s => s.perfect >= 1 },
            math_wizard: { icon: 'üßô', name: 'Math Wizard', desc: '5 Math exams', check: s => s.subjects.math >= 5 },
            wordsmith: { icon: 'üìñ', name: 'Wordsmith', desc: '5 English exams', check: s => s.subjects.english >= 5 },
            scientist: { icon: 'üî≠', name: 'Scientist', desc: '5 Science exams', check: s => s.subjects.science >= 5 },
            historian: { icon: 'üåè', name: 'Historian', desc: '5 Social exams', check: s => s.subjects.social >= 5 },
            excellence: { icon: 'üèÜ', name: 'Excellence', desc: 'Get E7/E8', check: s => s.excellence >= 1 },
            dedicated: { icon: 'üìö', name: 'Dedicated', desc: '10 exams', check: s => s.exams >= 10 },
            speed_demon: { icon: '‚ö°', name: 'Speed Demon', desc: 'Finish <2min', check: s => s.fastExams >= 1 },
            unstoppable: { icon: 'üöÄ', name: 'Unstoppable', desc: '25 exams', check: s => s.exams >= 25 },
            master: { icon: 'üëë', name: 'Master', desc: '5000+ XP', check: s => s.xp >= 5000 },
            streak_king: { icon: 'üî•', name: 'Streak King', desc: '14-day streak', check: s => s.streak >= 14 },
            all_rounder: { icon: 'üåü', name: 'All Rounder', desc: '3+ each subject', check: s => s.subjects.math >= 3 && s.subjects.english >= 3 && s.subjects.science >= 3 && s.subjects.social >= 3 }
        };

        // ============ QUESTIONS ============
        const questions = {
            math: {
                name: "Mathematics", icon: "üìê", from: "#3b82f6", to: "#06b6d4",
                topics: {
                    "Number & Algebra": [
                        { q: "Simplify: 3x + 5x - 2x", opts: ["6x", "8x", "10x", "4x"], ans: 0, exp: "(3+5-2)x = 6x", diff: "A3-A4" },
                        { q: "What is 2¬≥ √ó 2¬≤?", opts: ["32", "16", "64", "8"], ans: 0, exp: "2¬≥ √ó 2¬≤ = 2‚Åµ = 32", diff: "M5-M6" },
                        { q: "Solve: 2x + 7 = 15", opts: ["x = 4", "x = 8", "x = 11", "x = 3"], ans: 0, exp: "2x = 8, x = 4", diff: "A3-A4" },
                        { q: "What is 15% of 80?", opts: ["12", "15", "8", "10"], ans: 0, exp: "0.15 √ó 80 = 12", diff: "A3-A4" },
                        { q: "Next: 2, 6, 18, 54, ...?", opts: ["162", "108", "72", "216"], ans: 0, exp: "√ó3: 54√ó3=162", diff: "M5-M6" },
                        { q: "Factorise: x¬≤ - 9", opts: ["(x+3)(x-3)", "(x+9)(x-1)", "(x-3)¬≤", "(x+3)¬≤"], ans: 0, exp: "Difference of squares", diff: "E7-E8" },
                        { q: "Ratio 3:5, 24 boys. Girls?", opts: ["40", "30", "45", "35"], ans: 0, exp: "1 part=8, 5√ó8=40", diff: "M5-M6" }
                    ],
                    "Geometry": [
                        { q: "Area: 8cm √ó 5cm?", opts: ["40 cm¬≤", "26 cm¬≤", "13 cm¬≤", "80 cm¬≤"], ans: 0, exp: "8√ó5 = 40", diff: "A3-A4" },
                        { q: "Triangle angles sum?", opts: ["180¬∞", "360¬∞", "90¬∞", "270¬∞"], ans: 0, exp: "Always 180¬∞", diff: "A3-A4" },
                        { q: "135¬∞ is what angle?", opts: ["Obtuse", "Acute", "Right", "Reflex"], ans: 0, exp: "90¬∞-180¬∞ = obtuse", diff: "A3-A4" },
                        { q: "Pythagoras: 3,4 ‚Üí ?", opts: ["5", "7", "6", "12"], ans: 0, exp: "9+16=25, ‚àö25=5", diff: "E7-E8" },
                        { q: "Circumference r=7 (œÄ=22/7)?", opts: ["44 cm", "154 cm", "22 cm", "88 cm"], ans: 0, exp: "2œÄr = 44", diff: "M5-M6" }
                    ],
                    "Statistics": [
                        { q: "Mean: 4,7,8,9,12?", opts: ["8", "7", "9", "8.5"], ans: 0, exp: "40√∑5=8", diff: "A3-A4" },
                        { q: "Median: 3,7,9,12,15?", opts: ["9", "7", "12", "9.2"], ans: 0, exp: "Middle = 9", diff: "A3-A4" },
                        { q: "Mode: 2,4,4,5,7,4,8?", opts: ["4", "5", "2", "7"], ans: 0, exp: "4 appears most", diff: "A3-A4" },
                        { q: "Range: 15,22,8,31,19?", opts: ["23", "31", "8", "19"], ans: 0, exp: "31-8=23", diff: "A3-A4" }
                    ]
                }
            },
            english: {
                name: "English ESOL", icon: "üìö", from: "#8b5cf6", to: "#ec4899",
                topics: {
                    "Vocabulary": [
                        { q: "Synonym for 'happy'?", opts: ["Joyful", "Sad", "Angry", "Tired"], ans: 0, exp: "Joyful = happy", diff: "A3-A4" },
                        { q: "Antonym for 'ancient'?", opts: ["Modern", "Old", "Historic", "Traditional"], ans: 0, exp: "Modern = opposite", diff: "A3-A4" },
                        { q: "Which is a noun?", opts: ["Happiness", "Happy", "Happily", "Happier"], ans: 0, exp: "Happiness = thing", diff: "M5-M6" },
                        { q: "Prefix 'un-' means?", opts: ["Not", "Very", "Before", "After"], ans: 0, exp: "un- = not", diff: "A3-A4" },
                        { q: "Suffix '-ful' means?", opts: ["Full of", "Without", "Before", "Again"], ans: 0, exp: "hopeful = full of hope", diff: "A3-A4" }
                    ],
                    "Grammar": [
                        { q: "Correct sentence?", opts: ["She doesn't like apples.", "She don't like apples.", "She not like apples.", "She no like apples."], ans: 0, exp: "doesn't with she/he/it", diff: "A3-A4" },
                        { q: "'The book is _____' (Maria)", opts: ["hers", "her", "she", "herself"], ans: 0, exp: "Possessive pronoun", diff: "M5-M6" },
                        { q: "Compound sentence?", opts: ["I went to shop, and bought milk.", "Although it rained.", "The big red car.", "Running quickly."], ans: 0, exp: "Two clauses + 'and'", diff: "E7-E8" },
                        { q: "Past tense of 'go'?", opts: ["went", "goed", "gone", "going"], ans: 0, exp: "Irregular verb", diff: "A3-A4" }
                    ],
                    "Writing": [
                        { q: "Topic sentence purpose?", opts: ["Introduce main idea", "Conclude", "Examples", "Cite"], ans: 0, exp: "Sets direction", diff: "M5-M6" },
                        { q: "Which shows contrast?", opts: ["However", "Therefore", "Furthermore", "Similarly"], ans: 0, exp: "However = but", diff: "M5-M6" },
                        { q: "Writing to convince = ?", opts: ["Persuasive", "Narrative", "Descriptive", "Expository"], ans: 0, exp: "Persuade = convince", diff: "A3-A4" }
                    ]
                }
            },
            science: {
                name: "Science", icon: "üî¨", from: "#22c55e", to: "#14b8a6",
                topics: {
                    "Chemistry": [
                        { q: "Water symbol?", opts: ["H‚ÇÇO", "CO‚ÇÇ", "NaCl", "O‚ÇÇ"], ans: 0, exp: "2H + 1O", diff: "A3-A4" },
                        { q: "NOT chemical reaction sign?", opts: ["Shape change", "Colour change", "Gas", "Heat"], ans: 0, exp: "Shape = physical", diff: "M5-M6" },
                        { q: "3 states of matter?", opts: ["Solid, liquid, gas", "Hot, warm, cold", "Big, medium, small", "Hard, soft, flexible"], ans: 0, exp: "Basic states", diff: "A3-A4" },
                        { q: "Metals on periodic table?", opts: ["Left", "Right", "Top", "Bottom"], ans: 0, exp: "Left side", diff: "M5-M6" },
                        { q: "What is an atom?", opts: ["Smallest particle", "Molecule", "Reaction", "State"], ans: 0, exp: "Building block", diff: "A3-A4" }
                    ],
                    "Biology": [
                        { q: "Cell powerhouse?", opts: ["Mitochondria", "Nucleus", "Membrane", "Ribosome"], ans: 0, exp: "Makes energy", diff: "A3-A4" },
                        { q: "Plants make food by?", opts: ["Photosynthesis", "Respiration", "Digestion", "Fermentation"], ans: 0, exp: "Light+CO‚ÇÇ+H‚ÇÇO", diff: "A3-A4" },
                        { q: "Nucleus function?", opts: ["Controls cell, DNA", "Energy", "Proteins", "Water"], ans: 0, exp: "Control center", diff: "M5-M6" },
                        { q: "Ecosystem is?", opts: ["Living + environment", "One organism", "Plants only", "Animals only"], ans: 0, exp: "All together", diff: "M5-M6" }
                    ],
                    "Physics": [
                        { q: "Force unit?", opts: ["Newton", "Joule", "Watt", "Metre"], ans: 0, exp: "Named after Newton", diff: "A3-A4" },
                        { q: "Moving car energy?", opts: ["Kinetic", "Potential", "Chemical", "Nuclear"], ans: 0, exp: "Kinetic = motion", diff: "A3-A4" },
                        { q: "Light through prism?", opts: ["Separates colours", "Brighter", "Disappears", "Laser"], ans: 0, exp: "Spectrum", diff: "M5-M6" }
                    ]
                }
            },
            social: {
                name: "Social Science", icon: "üåè", from: "#f97316", to: "#ef4444",
                topics: {
                    "NZ History": [
                        { q: "Treaty of Waitangi year?", opts: ["1840", "1800", "1900", "1776"], ans: 0, exp: "6 Feb 1840", diff: "A3-A4" },
                        { q: "First NZ settlers?", opts: ["MƒÅori", "British", "Dutch", "Australian"], ans: 0, exp: "Polynesian ~1300AD", diff: "A3-A4" },
                        { q: "Treaty principles?", opts: ["Partnership, Protection, Participation", "Peace, Power, Prosperity", "Land, Law, Liberty", "King, Country, Crown"], ans: 0, exp: "The 3 P's", diff: "M5-M6" }
                    ],
                    "Geography": [
                        { q: "NZ earthquakes from?", opts: ["Convergent boundary", "Divergent", "Transform", "None"], ans: 0, exp: "Pacific+Australian plates", diff: "M5-M6" },
                        { q: "Sustainability means?", opts: ["Meet needs, protect future", "Use quickly", "Ignore", "Build more"], ans: 0, exp: "Future generations", diff: "A3-A4" },
                        { q: "Climate change cause?", opts: ["Greenhouse gases", "Moon", "Volcanoes only", "Oceans only"], ans: 0, exp: "Human CO‚ÇÇ", diff: "M5-M6" }
                    ],
                    "Civics": [
                        { q: "NZ government type?", opts: ["Parliamentary democracy", "Presidential", "Monarchy", "Dictatorship"], ans: 0, exp: "Elected parliament", diff: "A3-A4" },
                        { q: "NZ voting age?", opts: ["18", "16", "21", "25"], ans: 0, exp: "18 years", diff: "A3-A4" }
                    ]
                }
            }
        };

        // ============ GRADES ============
        const grades = {
            N0: { min: 0, max: 9, label: "Not Achieved", color: "#ef4444", emoji: "üòî" },
            N1: { min: 10, max: 19, label: "Not Achieved", color: "#ef4444", emoji: "üòï" },
            N2: { min: 20, max: 39, label: "Not Achieved", color: "#f97316", emoji: "ü§î" },
            A3: { min: 40, max: 49, label: "Achieved", color: "#eab308", emoji: "üòä" },
            A4: { min: 50, max: 59, label: "Achieved", color: "#84cc16", emoji: "üôÇ" },
            M5: { min: 60, max: 69, label: "Merit", color: "#22c55e", emoji: "üòÑ" },
            M6: { min: 70, max: 79, label: "Merit", color: "#14b8a6", emoji: "üòÉ" },
            E7: { min: 80, max: 89, label: "Excellence", color: "#3b82f6", emoji: "üåü" },
            E8: { min: 90, max: 100, label: "Excellence", color: "#8b5cf6", emoji: "üèÜ" }
        };

        function getGrade(pct) {
            for (const [g, d] of Object.entries(grades)) {
                if (pct >= d.min && pct <= d.max) return { grade: g, ...d };
            }
            return { grade: "N0", ...grades.N0 };
        }

        // ============ STATE ============
        let state = JSON.parse(localStorage.getItem('rangiData') || 'null') || {
            name: '', xp: 0, streak: 0, exams: 0, perfect: 0, excellence: 0, fastExams: 0,
            subjects: { math: 0, english: 0, science: 0, social: 0 },
            history: [], badges: [], lastStudyDate: null, lastBackup: null,
            dailyProgress: {}
        };

        let view = 'welcome';
        let currentExam = null;
        let examState = { q: 0, answers: [], time: 180, feedback: false, selected: null };
        let showSyncModal = false;
        let syncTab = 'export';
        let syncMessage = null;
        let newBadges = [];
        let selectedDay = null;

        // ============ HELPERS ============
        function getTodayStr() { return new Date().toISOString().split('T')[0]; }
        function getDayProgress(dateStr) { return state.dailyProgress[dateStr] || { exams: 0, completed: false }; }
        function getDayPlan(dateStr) { return dailyPlan.find(d => d.date === dateStr); }
        function getCurrentWeek() {
            const diffDays = Math.floor((new Date() - PLAN_START) / (1000 * 60 * 60 * 24));
            return Math.max(1, Math.min(6, Math.floor(diffDays / 7) + 1));
        }
        
        function getOverallProgress() {
            let totalGoal = 0, totalDone = 0;
            const today = getTodayStr();
            dailyPlan.forEach(day => {
                if (day.date <= today) {
                    totalGoal += day.goal;
                    totalDone += Math.min(getDayProgress(day.date).exams, day.goal);
                }
            });
            return totalGoal > 0 ? Math.round((totalDone / totalGoal) * 100) : 0;
        }
        
        function getWeekProgress(weekNum) {
            const weekDays = dailyPlan.filter(d => d.week === weekNum);
            let goal = 0, done = 0;
            const today = getTodayStr();
            weekDays.forEach(day => {
                if (day.date <= today) {
                    goal += day.goal;
                    done += Math.min(getDayProgress(day.date).exams, day.goal);
                }
            });
            return goal > 0 ? Math.round((done / goal) * 100) : 0;
        }

        function updateStreak() {
            const today = new Date().toDateString();
            const lastDate = state.lastStudyDate ? new Date(state.lastStudyDate).toDateString() : null;
            if (lastDate === today) return;
            const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
            if (lastDate === yesterday.toDateString()) state.streak++;
            else state.streak = 1;
            state.lastStudyDate = new Date().toISOString();
        }
        
        function updateDailyProgress() {
            const today = getTodayStr();
            const dayPlan = getDayPlan(today);
            if (!state.dailyProgress[today]) state.dailyProgress[today] = { exams: 0, completed: false };
            state.dailyProgress[today].exams++;
            if (dayPlan && state.dailyProgress[today].exams >= dayPlan.goal) state.dailyProgress[today].completed = true;
        }

        function checkBadges() {
            newBadges = [];
            for (const [id, badge] of Object.entries(badgesDef)) {
                if (!state.badges.includes(id) && badge.check(state)) {
                    state.badges.push(id);
                    newBadges.push(id);
                }
            }
            return newBadges;
        }

        function save() { localStorage.setItem('rangiData', JSON.stringify(state)); }

        function downloadData() {
            const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `rangitoto-backup-${getTodayStr()}.json`;
            a.click();
            state.lastBackup = new Date().toISOString();
            save();
            syncMessage = { type: 'success', text: '‚úÖ Downloaded!' };
            render();
        }

        function importData() {
            const textarea = document.getElementById('importData');
            if (textarea?.value.trim()) {
                try {
                    const imported = JSON.parse(textarea.value.trim());
                    if (imported.name) {
                        state = { ...state, ...imported };
                        if (!state.dailyProgress) state.dailyProgress = {};
                        save();
                        syncMessage = { type: 'success', text: '‚úÖ Imported!' };
                        showSyncModal = false;
                        render();
                    }
                } catch (e) { syncMessage = { type: 'error', text: '‚ùå Error' }; render(); }
            }
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { document.getElementById('importData').value = e.target.result; };
                reader.readAsText(file);
            }
        }

        // ============ RENDER ============
        function render() {
            const app = document.getElementById('app');
            let html = '';
            if (showSyncModal) html += syncModalHTML();
            if (!state.name) html += welcomeHTML();
            else if (currentExam) html += examHTML();
            else if (selectedDay) html += dayDetailHTML();
            else html += mainHTML();
            app.innerHTML = html;
        }

        function welcomeHTML() {
            return `
                <div class="glass text-center bounce-in" style="max-width:500px;margin:50px auto;">
                    <div class="text-6xl mb-4 floating">üéì</div>
                    <h1 class="text-4xl font-bold mb-4">Rangitoto</h1>
                    <h2 class="text-2xl text-purple mb-6">Year 9 Review Hub</h2>
                    <p class="text-gray mb-6">6-Week Summer Study Plan<br>Dec 6, 2025 - Jan 17, 2026</p>
                    <input class="input" type="text" id="nameInput" placeholder="Enter your name...">
                    <button class="btn" onclick="startApp()">Start Learning! üöÄ</button>
                    <div style="border-top:1px solid rgba(255,255,255,0.2);padding-top:20px;margin-top:20px;">
                        <button class="btn btn-secondary" onclick="showSyncModal=true;syncTab='import';render()">üìÇ Import Backup</button>
                    </div>
                </div>
            `;
        }

        function syncModalHTML() {
            return `
                <div class="modal-overlay" onclick="if(event.target===this){showSyncModal=false;syncMessage=null;render();}">
                    <div class="modal">
                        <h2 class="text-2xl font-bold mb-4">üíæ Backup</h2>
                        <div class="tabs">
                            <button class="tab ${syncTab === 'export' ? 'active' : ''}" onclick="syncTab='export';render()">üì§ Export</button>
                            <button class="tab ${syncTab === 'import' ? 'active' : ''}" onclick="syncTab='import';render()">üì• Import</button>
                        </div>
                        ${syncMessage ? `<div class="alert alert-${syncMessage.type === 'success' ? 'success' : 'warning'}">${syncMessage.text}</div>` : ''}
                        ${syncTab === 'export' ? `<button class="btn btn-green" onclick="downloadData()">üì• Download Backup</button>` : `
                            <input type="file" accept=".json" onchange="handleFileUpload(event)" class="input">
                            <textarea class="input" id="importData" placeholder="Or paste data..."></textarea>
                            <button class="btn btn-orange" onclick="importData()">üì• Import</button>
                        `}
                        <button class="btn btn-secondary mt-4" onclick="showSyncModal=false;syncMessage=null;render()">Close</button>
                    </div>
                </div>
            `;
        }

        function startApp() {
            const name = document.getElementById('nameInput').value.trim();
            if (name) { state.name = name; if (!state.dailyProgress) state.dailyProgress = {}; save(); render(); }
        }

        function mainHTML() {
            const health = Math.min(100, Math.round((state.exams / 3) * 80 + state.streak * 3));
            const healthClass = health >= 60 ? 'health-good' : health >= 30 ? 'health-warning' : 'health-danger';
            
            return `
                <div class="header">
                    <div class="flex items-center gap-4">
                        <span class="text-4xl floating">üéì</span>
                        <div>
                            <h1 class="text-xl font-bold">Kia ora, ${state.name}!</h1>
                            <span class="text-yellow">‚ö° ${state.xp} XP</span>
                            ${state.streak > 0 ? `<span class="text-gray"> | üî• ${state.streak}</span>` : ''}
                        </div>
                    </div>
                    <div class="flex gap-2 items-center flex-wrap">
                        <button class="btn btn-small btn-secondary" onclick="showSyncModal=true;syncTab='export';render()">üíæ</button>
                        <div class="health-bar ${healthClass}">${health}%</div>
                    </div>
                </div>
                
                <div class="nav">
                    <button class="nav-btn ${view === 'plan' ? 'active' : ''}" onclick="setView('plan')">üìÖ Plan</button>
                    <button class="nav-btn ${view === 'dashboard' ? 'active' : ''}" onclick="setView('dashboard')">üè† Home</button>
                    <button class="nav-btn ${view === 'subjects' ? 'active' : ''}" onclick="setView('subjects')">üìö Subjects</button>
                    <button class="nav-btn ${view === 'badges' ? 'active' : ''}" onclick="setView('badges')">üèÖ Badges</button>
                    <button class="nav-btn ${view === 'stats' ? 'active' : ''}" onclick="setView('stats')">üìä Stats</button>
                </div>
                
                ${view === 'plan' ? planHTML() : view === 'dashboard' ? dashboardHTML() : view === 'subjects' ? subjectsHTML() : view === 'badges' ? badgesHTML() : statsHTML()}
            `;
        }

        function setView(v) { view = v; render(); }

        function planHTML() {
            const today = getTodayStr();
            const currentWeek = getCurrentWeek();
            const overallProgress = getOverallProgress();
            const todayPlan = getDayPlan(today);
            const todayProgress = getDayProgress(today);
            
            return `
                <div class="glass">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xl font-bold">üìÖ 6-Week Study Plan</h2>
                        <span class="badge-tag badge-purple">Week ${currentWeek}/6</span>
                    </div>
                    <p class="text-gray text-sm mb-4">Dec 6, 2025 - Jan 17, 2026</p>
                    
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span>Overall Progress</span>
                            <span class="font-bold">${overallProgress}%</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill green" style="width:${overallProgress}%"></div></div>
                    </div>
                    
                    ${todayPlan ? `
                    <div class="day-task-card" style="background:linear-gradient(135deg, ${todayPlan.weekPlan.color.from}33, ${todayPlan.weekPlan.color.to}33); border-left: 4px solid ${todayPlan.weekPlan.color.from}">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-3">
                                <span style="font-size:28px">${todayPlan.icon}</span>
                                <div>
                                    <div class="font-bold">Today's Task</div>
                                    <div class="text-sm text-gray">${todayPlan.isRest ? 'Rest Day! üéâ' : todayPlan.topic}</div>
                                </div>
                            </div>
                            <span class="task-status ${todayProgress.completed ? 'status-complete' : todayProgress.exams > 0 ? 'status-partial' : 'status-pending'}">
                                ${todayProgress.completed ? '‚úì Done' : `${todayProgress.exams}/${todayPlan.goal}`}
                            </span>
                        </div>
                        ${!todayPlan.isRest && !todayProgress.completed ? `
                        <button class="btn btn-small btn-green" onclick="startDayTask('${today}')">
                            ${todayProgress.exams > 0 ? 'Continue' : 'Start'} ‚Üí
                        </button>
                        ` : ''}
                    </div>
                    ` : ''}
                </div>
                
                <div class="glass">
                    <h3 class="text-lg font-bold mb-4">üìÜ Calendar</h3>
                    ${[1,2,3,4,5,6].map(weekNum => {
                        const weekData = weeklyPlan[weekNum - 1];
                        const weekDays = dailyPlan.filter(d => d.week === weekNum);
                        const weekProgress = getWeekProgress(weekNum);
                        const isCurrent = weekNum === currentWeek;
                        
                        return `
                        <div class="week-card ${isCurrent ? 'current' : ''}" style="--accent:${weekData.color.from}">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2">
                                    <span style="font-size:20px">${weekData.icon}</span>
                                    <span class="font-bold">${weekData.name}</span>
                                    <span class="text-sm text-gray">${weekData.dates}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    ${isCurrent ? '<span class="badge-tag badge-yellow" style="font-size:10px">NOW</span>' : ''}
                                    <span class="text-sm font-bold">${weekProgress}%</span>
                                </div>
                            </div>
                            <div class="text-sm text-gray mb-3">${weekData.topic}</div>
                            <div class="calendar-grid">
                                ${['S','M','T','W','T','F','S'].map(d => `<div class="calendar-day-header">${d}</div>`).join('')}
                                ${renderWeekDays(weekDays, today)}
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
                
                <div class="glass">
                    <h3 class="text-lg font-bold mb-2">üìñ Legend</h3>
                    <div class="flex flex-wrap gap-3 text-sm">
                        <span>‚úÖ Complete</span>
                        <span>üìù In Progress</span>
                        <span>‚ùå Missed</span>
                        <span>‚≠ê Today</span>
                        <span>üéÑ Rest</span>
                    </div>
                </div>
            `;
        }
        
        function renderWeekDays(weekDays, today) {
            let html = '';
            const firstDay = weekDays[0]?.dayOfWeek || 0;
            for (let i = 0; i < firstDay; i++) html += '<div class="calendar-day disabled"></div>';
            
            weekDays.forEach(day => {
                const progress = getDayProgress(day.date);
                const isToday = day.date === today;
                const isPast = day.date < today;
                const isFuture = day.date > today;
                const pct = day.goal > 0 ? Math.min(100, (progress.exams / day.goal) * 100) : 100;
                
                let statusClass = '';
                if (day.isRest) statusClass = 'rest-day';
                else if (progress.completed) statusClass = 'completed';
                else if (progress.exams > 0) statusClass = 'partial';
                else if (isPast) statusClass = 'past-incomplete';
                else if (isFuture) statusClass = 'future';
                
                const icon = day.isRest ? 'üéÑ' : (progress.completed ? '‚úÖ' : (progress.exams > 0 ? 'üìù' : (isPast ? '‚ùå' : day.icon)));
                
                html += `
                    <div class="calendar-day ${statusClass} ${isToday ? 'today today-glow' : ''}" onclick="openDayDetail('${day.date}')">
                        <span class="day-num">${new Date(day.date).getDate()}</span>
                        <span class="day-icon">${icon}</span>
                        ${!day.isRest && day.goal > 0 ? `<div class="day-progress"><div class="day-progress-fill" style="width:${pct}%"></div></div>` : ''}
                    </div>
                `;
            });
            
            const lastDay = weekDays[weekDays.length - 1]?.dayOfWeek || 6;
            for (let i = lastDay + 1; i <= 6; i++) html += '<div class="calendar-day disabled"></div>';
            return html;
        }
        
        function openDayDetail(dateStr) { selectedDay = dateStr; render(); }
        function closeDayDetail() { selectedDay = null; render(); }
        
        function dayDetailHTML() {
            const day = getDayPlan(selectedDay);
            const progress = getDayProgress(selectedDay);
            if (!day) { selectedDay = null; return ''; }
            
            const dateObj = new Date(selectedDay);
            const dateFormatted = dateObj.toLocaleDateString('en-NZ', { weekday: 'long', month: 'short', day: 'numeric' });
            
            return `
                <div class="glass">
                    <button onclick="closeDayDetail()" class="text-gray mb-4" style="background:none;border:none;cursor:pointer">‚Üê Back</button>
                    
                    <div class="flex items-center gap-4 mb-4">
                        <span style="font-size:48px">${day.icon}</span>
                        <div>
                            <h2 class="text-2xl font-bold">${dateFormatted}</h2>
                            <p class="text-gray">${day.isRest ? 'Rest Day üéÑ' : day.topic}</p>
                        </div>
                    </div>
                    
                    ${day.isRest ? `<div class="alert alert-success"><p class="text-xl">üéâ Enjoy your break!</p></div>` : `
                        <div class="mb-4">
                            <div class="flex justify-between mb-2">
                                <span>Progress</span>
                                <span class="font-bold">${progress.exams}/${day.goal}</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill ${progress.completed ? 'green' : ''}" style="width:${Math.min(100, (progress.exams / day.goal) * 100)}%"></div></div>
                        </div>
                        
                        ${progress.completed ? `<div class="alert alert-success"><p class="font-bold">‚úÖ Complete!</p></div>` : ''}
                        
                        <button class="btn btn-green" onclick="startDayTask('${selectedDay}')">
                            ${progress.completed ? 'üìù Extra Practice' : 'üöÄ Start'} - ${day.topic}
                        </button>
                    `}
                </div>
                
                ${!day.isRest ? `
                <div class="glass">
                    <h3 class="text-lg font-bold mb-4">üìö Topics</h3>
                    ${day.subject === 'all' ? 
                        Object.entries(questions).map(([k, v]) => `
                            <button class="topic-btn" onclick="startExamFromDay('${selectedDay}', '${k}', '${Object.keys(v.topics)[0]}')">
                                <span>${v.icon} ${v.name}</span><span class="text-gray">‚Üí</span>
                            </button>
                        `).join('')
                    :
                        Object.entries(questions[day.subject].topics).map(([topic]) => `
                            <button class="topic-btn" onclick="startExamFromDay('${selectedDay}', '${day.subject}', '${topic}')">
                                <span>${topic}</span><span class="text-gray">‚Üí</span>
                            </button>
                        `).join('')
                    }
                </div>
                ` : ''}
            `;
        }
        
        function startDayTask(dateStr) {
            const day = getDayPlan(dateStr);
            if (!day || day.isRest) return;
            selectedDay = dateStr;
            if (day.subject === 'all') {
                const subjects = ['math', 'english', 'science', 'social'];
                const sub = subjects[Math.floor(Math.random() * subjects.length)];
                const topics = Object.keys(questions[sub].topics);
                startExamFromDay(dateStr, sub, topics[Math.floor(Math.random() * topics.length)]);
            } else {
                startExamFromDay(dateStr, day.subject, day.topic);
            }
        }
        
        function startExamFromDay(dateStr, subject, topic) {
            const qs = questions[subject].topics[topic];
            if (!qs) return;
            const shuffled = [...qs].sort(() => Math.random() - 0.5).slice(0, Math.min(5, qs.length));
            currentExam = { subject, topic, questions: shuffled, startTime: Date.now(), forDate: dateStr };
            examState = { q: 0, answers: [], time: 180, feedback: false, selected: null };
            selectedDay = null;
            render();
            startTimer();
        }

        function dashboardHTML() {
            const today = getTodayStr();
            const todayPlan = getDayPlan(today);
            const todayProgress = getDayProgress(today);
            const overallProgress = getOverallProgress();
            
            return `
                ${todayPlan ? `
                <div class="glass" style="background:linear-gradient(135deg, ${todayPlan.weekPlan.color.from}22, ${todayPlan.weekPlan.color.to}22)">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-3">
                            <span style="font-size:40px">${todayPlan.icon}</span>
                            <div>
                                <h2 class="text-xl font-bold">Today</h2>
                                <p class="text-gray">${todayPlan.isRest ? 'Rest Day!' : todayPlan.topic}</p>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold">${todayProgress.exams}/${todayPlan.goal}</div>
                        </div>
                    </div>
                    ${!todayPlan.isRest ? `
                    <div class="progress-bar mb-4"><div class="progress-fill ${todayProgress.completed ? 'green' : ''}" style="width:${Math.min(100, (todayProgress.exams / todayPlan.goal) * 100)}%"></div></div>
                    ${!todayProgress.completed ? `<button class="btn btn-green" onclick="startDayTask('${today}')">üöÄ Study Now</button>` : `<p class="text-green font-bold text-center">‚úÖ Done!</p>`}
                    ` : ''}
                </div>
                ` : ''}
                
                <div class="glass">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">üìÖ 6-Week Progress</h2>
                        <span class="font-bold">${overallProgress}%</span>
                    </div>
                    <div class="progress-bar mb-4"><div class="progress-fill green" style="width:${overallProgress}%"></div></div>
                    <button class="btn btn-small btn-secondary" onclick="setView('plan')">View Calendar ‚Üí</button>
                </div>
                
                <div class="glass">
                    <h2 class="text-xl font-bold mb-4">üìä Stats</h2>
                    <div class="stats-row"><span>XP</span><span class="text-yellow font-bold">‚ö° ${state.xp}</span></div>
                    <div class="stats-row"><span>Exams</span><span class="text-green font-bold">‚úÖ ${state.exams}</span></div>
                    <div class="stats-row"><span>Streak</span><span style="color:#f97316" class="font-bold">üî• ${state.streak}</span></div>
                    <div class="stats-row"><span>Badges</span><span class="font-bold">üèÖ ${state.badges.length}/${Object.keys(badgesDef).length}</span></div>
                </div>
                
                <div class="glass">
                    <h2 class="text-xl font-bold mb-4">‚ö° Quick Practice</h2>
                    <div class="grid grid-2 gap-4">
                        ${Object.entries(questions).map(([k, v]) => `
                            <button class="subject-card" style="--from:${v.from};--to:${v.to}" onclick="setView('subjects')">
                                <div class="icon">${v.icon}</div>
                                <div class="font-bold">${v.name}</div>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function badgesHTML() {
            return `
                <div class="glass">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">üèÖ Badges</h2>
                        <span class="badge-tag badge-purple">${state.badges.length}/${Object.keys(badgesDef).length}</span>
                    </div>
                    <div class="grid grid-3 gap-3">
                        ${Object.entries(badgesDef).map(([id, badge]) => `
                            <div class="badge-card ${state.badges.includes(id) ? 'earned' : 'locked'}">
                                <span class="badge-icon">${badge.icon}</span>
                                <div class="badge-name">${badge.name}</div>
                                <div class="badge-desc">${badge.desc}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function subjectsHTML() {
            return `
                <div class="glass">
                    <h2 class="text-xl font-bold mb-4">üìö Subjects</h2>
                    ${Object.entries(questions).map(([k, v]) => `
                        <div class="subject-card mb-4" style="--from:${v.from};--to:${v.to};cursor:default">
                            <div class="flex items-center gap-4 mb-2">
                                <span class="text-4xl">${v.icon}</span>
                                <div><div class="font-bold">${v.name}</div><div class="text-sm" style="opacity:0.7">${state.subjects[k]} done</div></div>
                            </div>
                            ${Object.entries(v.topics).map(([topic]) => `
                                <button class="topic-btn" onclick="startExam('${k}','${topic}')"><span>${topic}</span><span class="text-gray">‚Üí</span></button>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function statsHTML() {
            return `
                <div class="glass">
                    <h2 class="text-xl font-bold mb-4">üìä Stats</h2>
                    <div class="stats-row"><span>XP</span><span class="text-yellow font-bold">‚ö° ${state.xp}</span></div>
                    <div class="stats-row"><span>Exams</span><span class="text-green font-bold">‚úÖ ${state.exams}</span></div>
                    <div class="stats-row"><span>Streak</span><span style="color:#f97316" class="font-bold">üî• ${state.streak}</span></div>
                    <div class="stats-row"><span>Perfect</span><span class="text-purple font-bold">üíØ ${state.perfect}</span></div>
                    <div class="stats-row"><span>Excellence</span><span style="color:#8b5cf6" class="font-bold">üèÜ ${state.excellence}</span></div>
                    <h3 class="text-lg font-bold mt-4 mb-2">By Subject</h3>
                    ${Object.entries(questions).map(([k, v]) => `<div class="stats-row"><span>${v.icon} ${v.name}</span><span>${state.subjects[k]}</span></div>`).join('')}
                </div>
            `;
        }

        function startExam(subject, topic) {
            const qs = questions[subject].topics[topic];
            const shuffled = [...qs].sort(() => Math.random() - 0.5).slice(0, Math.min(5, qs.length));
            currentExam = { subject, topic, questions: shuffled, startTime: Date.now(), forDate: getTodayStr() };
            examState = { q: 0, answers: [], time: 180, feedback: false, selected: null };
            render();
            startTimer();
        }

        let timerInterval;
        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (examState.time > 0 && !examState.feedback) {
                    examState.time--;
                    const el = document.getElementById('timer');
                    if (el) el.textContent = `${Math.floor(examState.time/60)}:${(examState.time%60).toString().padStart(2,'0')}`;
                }
            }, 1000);
        }

        function examHTML() {
            const q = currentExam.questions[examState.q];
            const pct = ((examState.q + 1) / currentExam.questions.length) * 100;
            const sub = questions[currentExam.subject];
            
            return `
                <div class="glass">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-2"><span class="text-2xl">${sub.icon}</span><span class="font-bold">${currentExam.topic}</span></div>
                        <span id="timer" class="font-bold">${Math.floor(examState.time/60)}:${(examState.time%60).toString().padStart(2,'0')}</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                    <p class="text-gray text-sm mt-2">Q${examState.q + 1}/${currentExam.questions.length}</p>
                </div>
                
                <div class="glass bounce-in">
                    <span class="badge-tag ${q.diff.includes('E') ? 'badge-purple' : q.diff.includes('M') ? 'badge-green' : 'badge-yellow'}">${q.diff}</span>
                    <h2 class="text-xl font-bold" style="margin:15px 0 25px">${q.q}</h2>
                    ${q.opts.map((opt, i) => {
                        let cls = 'option-btn';
                        if (examState.feedback) {
                            if (i === q.ans) cls += ' correct';
                            else if (i === examState.selected) cls += ' wrong';
                        }
                        return `<button class="${cls}" ${examState.feedback ? 'disabled' : ''} onclick="answer(${i})">${String.fromCharCode(65+i)}. ${opt}</button>`;
                    }).join('')}
                    ${examState.feedback ? `
                        <div class="glass mt-4" style="background:${examState.selected === q.ans ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)'}">
                            <p class="font-bold ${examState.selected === q.ans ? 'text-green' : 'text-red'}">${examState.selected === q.ans ? '‚úÖ Correct!' : '‚ùå Wrong'}</p>
                            <p class="text-purple text-sm mt-2">üí° ${q.exp}</p>
                        </div>
                    ` : ''}
                </div>
                <button onclick="exitExam()" class="text-gray mt-2" style="background:none;border:none;cursor:pointer">‚Üê Exit</button>
            `;
        }

        function answer(i) {
            if (examState.feedback) return;
            examState.selected = i;
            examState.feedback = true;
            render();
            setTimeout(() => {
                examState.answers.push(i);
                examState.feedback = false;
                examState.selected = null;
                if (examState.q < currentExam.questions.length - 1) { examState.q++; render(); }
                else finishExam();
            }, 1500);
        }

        function finishExam() {
            clearInterval(timerInterval);
            let correct = 0;
            currentExam.questions.forEach((q, i) => { if (examState.answers[i] === q.ans) correct++; });
            
            const score = Math.round((correct / currentExam.questions.length) * 100);
            const gradeInfo = getGrade(score);
            const timeTaken = Math.floor((Date.now() - currentExam.startTime) / 1000);
            const isFast = timeTaken < 120;
            const xp = Math.round(score * 2 + (isFast ? 50 : 0));
            
            state.xp += xp;
            state.exams++;
            state.subjects[currentExam.subject]++;
            if (score === 100) state.perfect++;
            if (score >= 80) state.excellence++;
            if (isFast) state.fastExams = (state.fastExams || 0) + 1;
            
            updateStreak();
            updateDailyProgress();
            
            state.history.unshift({ subject: currentExam.subject, topic: currentExam.topic, score, grade: gradeInfo.grade, xp, date: new Date().toISOString() });
            state.history = state.history.slice(0, 20);
            
            const earned = checkBadges();
            save();
            showResults(score, gradeInfo, xp, correct, earned);
        }

        function showResults(score, gradeInfo, xp, correct, newlyEarned) {
            const today = getTodayStr();
            const todayPlan = getDayPlan(today);
            const todayProgress = getDayProgress(today);
            
            document.getElementById('app').innerHTML = `
                <div class="glass text-center bounce-in">
                    <div class="text-6xl mb-4">${gradeInfo.emoji}</div>
                    <h1 class="text-3xl font-bold mb-4">Complete!</h1>
                    <div class="flex justify-center gap-4 mb-6 flex-wrap">
                        <div><div class="text-3xl font-bold" style="color:${gradeInfo.color}">${score}%</div><div class="text-gray text-sm">Score</div></div>
                        <div><div class="text-3xl font-bold" style="color:${gradeInfo.color}">${gradeInfo.grade}</div><div class="text-gray text-sm">${gradeInfo.label}</div></div>
                        <div><div class="text-3xl font-bold text-yellow">+${xp}</div><div class="text-gray text-sm">XP</div></div>
                    </div>
                    ${todayPlan && !todayPlan.isRest ? `
                    <div class="mb-4">
                        <p class="text-sm text-gray mb-2">Today: ${todayProgress.exams}/${todayPlan.goal}</p>
                        <div class="progress-bar"><div class="progress-fill ${todayProgress.completed ? 'green' : ''}" style="width:${Math.min(100, (todayProgress.exams / todayPlan.goal) * 100)}%"></div></div>
                        ${todayProgress.completed ? '<p class="text-green font-bold mt-2">‚úÖ Today done!</p>' : ''}
                    </div>
                    ` : ''}
                    ${newlyEarned.length > 0 ? `
                        <div class="glass mb-4" style="background:linear-gradient(135deg, rgba(139,92,246,0.3), rgba(236,72,153,0.3));">
                            <h3 class="font-bold mb-2">üéâ New Badge!</h3>
                            <div class="flex justify-center gap-3">${newlyEarned.map(id => `<span style="font-size:40px">${badgesDef[id].icon}</span>`).join('')}</div>
                        </div>
                    ` : ''}
                    <button class="btn" onclick="backToMain()">Continue üöÄ</button>
                </div>
            `;
        }

        function backToMain() { currentExam = null; newBadges = []; view = 'plan'; render(); }
        function exitExam() { clearInterval(timerInterval); currentExam = null; view = 'plan'; render(); }

        // Init
        if (!state.dailyProgress) state.dailyProgress = {};
        view = state.name ? 'plan' : 'welcome';
        render();
    </script>
</body>
</html>
